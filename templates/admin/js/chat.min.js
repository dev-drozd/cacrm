var Chat = {
    flag: 0,
    position: {},
	preload: undefined,
    titleEvent: function(t,d) {
		var e = d.target, p = d.currentTarget.parentNode, open;
		if($(e).hasClass('fa-times')){
			$(p).css({
				left: '',
				top: '',
				bottom: ''
			}).removeClass("open").find('.fa-times').fadeOut();
			if($(window).width() < 600){
				$(p).find('.fa-comment').show();
			}
		} else if(!$(p).hasClass('open')){
			$(p).addClass("open");
			$(p).find('.fa-times').fadeIn();
			if($(window).width() < 600){
				$(p).find('.fa-comment').hide();
			}
			open = true;
		}
		if (event.pageX && event.pageY && !open) {
			w = $(window), $(t).css("cursor", "move");
			var a = $(t).parent().position(),
				e = parseInt(a.left || 0) - event.pageX,
				s = parseInt(a.top || 0) - event.pageY;
			Chat.position = {
				left: e + event.pageX,
				top: s + event.pageY
			}, w.mousemove(function(a) {
				if($('.mini-chat-search.open').length){
					$(t).parent().css({
						bottom: "inherit",
						left: e + a.pageX,
						top: s + a.pageY
					})
				}
			}), w.mouseup(function() {
				w.unbind("mousemove")
			})
		}	
    },
    toogle: function(t) {

		console.log(e);
		//if($(p).hasClass('open')){
			//$(p).css({
			//	left: '',
			//	top: '',
			//	bottom: ''
			//}).removeClass("open");
		//} else
			//$(p).addClass("open");
        //Chat.position.left != $(t).offset().left && Chat.position.top != $(t).offset().top || $(t).toggleClass("open")
    },
    search: function(t) {
        $.post("/chat/" + (this.flag ? "support" : "im"), {
            q: t || "",
            p: 0
        }, function(t) {
			clearTimeout(Chat.preload);
            $(".left-chat-list > ul").html(Chat.compileIm(t[0], Chat.flag))
        }, "json")
    },
/*     tab: function(t, a) {
        $(".mini-chat-list").html('<div class="mini-chat-messages">\t\t\t<div class="imAnim">\t\t\t\t<span class="fa fa-pulse fa-spinner"></span>\t\t\t</div>\t\t</div>'), a ? $(t).addClass("support") : $(t).removeClass("support"), this.flag = a, this.search()
    }, */
    compileIm: function(t, a) {
        var e = "";
        if (t.length)
            for (var s = 0; s < t.length; s++) e += '<li class="mini-chat-person" data-id="' + t[s].id + '" onclick="Chat.open(this' + (a ? ", 1" : "") + ');">\t\t\t\t\t' + (t[s].image ? '<img src="/uploads/images/' + (a ? "guests" : "users") + "/" + t[s].id + "/thumb_" + t[s].image + '" class="imImg">' : '<span class="fa fa-user-secret miniRound"></span>') + "\t\t\t\t\t " + t[s].name + " " + t[s].lastname + "\t\t\t\t</li>";
        return e
    },
    draggable: function(t) {
        var a = $(window);
        return t.mousedown(function(e) {
            if ($(e.target).hasClass("fa-times")) $('.block').remove(), t.remove(), a.unbind("mousemove");
            else if ($(e.target).hasClass("fa-window-maximize")) Page.get("/im/" + (Chat.flag ? "support/" : "") + t.attr("data-sid"));
            else if ($(e.target).hasClass("mini-chat-title") && e.pageX && e.pageY) {
                var s = t.position(),
                    i = parseInt(s.left || 0) - e.pageX,
                    n = parseInt(s.top || 0) - e.pageY;
                a.mousemove(function(a) {
                    t.css({
                        bottom: "inherit",
                        left: i + a.pageX,
                        top: n + a.pageY
                    }).removeClass("tmp")
                })
            }
        }), a.mouseup(function() {
            a.unbind("mousemove")
        }), t
    },
    open: function(t, a) {
        var e = $(".mini-chat.tmp"),
            s = t.name || $(t).text(),
            i = t.sid || $(t).attr("data-id"),
            n = (a ? "chat_guest" : "chat_user") + i;
		if(location.pathname.match(/\/im/i)){
			Im.open(t);
			return false;
		}
        e.length && e.remove(), this.draggable($('<div class="mini-chat tmp" id="' + n + '" data-sid="' + i + '">\t\t\t<div class="mini-chat-title">\t\t\t\t<span class="fa fa-times flRight"></span>\t\t\t\t<span class="fa fa-window-maximize flRight"></span>\t\t\t\t' + s + '\t\t\t</div>\t\t\t<div class="mini-chat-messages">\t\t\t\t<div class="imAnim"><span class="fa fa-pulse fa-spinner"></span></div>\t\t\t</div>\t\t\t<div class="mini-chat-form">\t\t\t\t<textarea name="message" placeholder="Enter message" data-sid="' + i + '" onkeydown="if(event.keyCode == 13) {Chat.send(this); return false;}"></textarea>\t\t\t</div>\t\t</div>')).appendTo("body"), $.post("/chat/history" + (this.flag || a ? "_support" : ""), {
            sid: i
        }, function(t) {
            $("#" + n + " .mini-chat-messages").html(Chat.compileMsg(t[0])).scrollTop(999999999)
        }, "json")
    },
    compileMsg: function(t) {
        var a = "";
        if (t.length)
            for (var e = 0; e < t.length; e++) a += '<div class="mini-chat-message' + (_user.id == t[e].from_uid || t[e].my ? " me" : "") + '" data-id="' + (t[e].id || 0) + '">\t\t\t\t\t<div class="mc-title">\t\t\t\t\t\t<span class="name">' + t[e].name + " " + t[e].lastname + '</span>\t\t\t\t\t\t<i class="name">' + t[e].date + '</i>\t\t\t\t\t</div>\t\t\t\t\t<div class="mc-content">\t\t\t\t\t\t' + t[e].message + "\t\t\t\t\t</div>\t\t\t\t</div>";
        return a
    },
    send: function(t) {
        var a = $(t),
            e = a.attr("data-sid"),
            s = a.val().trim(),
            i = $(this.compileMsg([{
                my: !0,
                name: _user.name,
                lastname: _user.lastname,
                message: $("<div/>", {
                    text: s
                }).html(),
                date: "Just now"
            }])),
            n = /chat_guest([0-9]+)/i.test(t.parentNode.parentNode.id),
            o = (n ? "chat_guest" : "chat_user") + e,
            m = new FormData;
        m.append("id", e), m.append("message", s), $("#" + o + " .mini-chat-messages").append(i).scrollTop(999999999), a.val(""), s.length ? ($(".block").remove(), $.ajax({
            type: "POST",
            dataType: "json",
            processData: !1,
            contentType: !1,
            url: "/im/" + (n ? "support/" : "") + "send",
            data: m
        }).done(function(t) {
            $(".imDialog").length && $(".imDialog").append(Im.compile(t.message)).scrollTop(999999999), i.attr("data-id", t.message.id).find(".mc-content").html(t.message.message)
        })) : alr.show({
            class: "alrDanger",
            content: "Message can not be empty",
            delay: 2
        })
    }
};