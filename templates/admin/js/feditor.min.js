!function(t){t.fn.fEditor=function(e){var a="object"==typeof e?e:t.extend({plugins:"*",spellcheck:!0},e);this.each(function(){var e=this;e.className="eArea",e.style.display="none",t(e).bind("paste blur",function(){e.parentNode.querySelector("div.eArea").innerHTML=e.value});var n=t("<div/>",{class:"eArea",contenteditable:!0,spellcheck:a.spellcheck,html:e.value}).bind("mousedown",function(e){switch(e.target.tagName){case"IMG":e.target.ondblclick=t.fEditor.editImage;break;case"A":t.fEditor.editLink(e)}}).bind("paste blur",function(){e.value=this.innerHTML}),i=t("<div/>",{class:"eTools"}),o=t("<div/>",{class:"editor",html:i}).append(n);t.fEditor.area=n,t.each(t.fEditor.methods,function(e,o){var l=a.plugins;return l&&"*"!==l?l.replace(/\s+/g,"").split(",").indexOf(e)>=0?o.apply(t.fEditor,[i,n]):null:o.apply(t.fEditor,[i,n])}),t(e).after(o).appendTo(o)})},t.fEditor=new function(e,a){this.lang={resize:"Full Screen",undo:"Back",redo:"Forward",bold:"Bold",italic:"italic",strike:"strikeout",underline:"underlined",left:"Align Left",center:"Centered",right:"Align Right",list:"List",numlist:"Numbered list",quote:"Tsytata",hr:"Horizontal Line",format:"Format",code:"Show code",color:"Text Color",background:"The background color of the text",text:"Text",size:"font size",header:"Title"},this.form_html=function(t){function e(t){var e="",a=4*t;if(!(t<0)){for(;a--;)e+=" ";return e}}for(var a="",n=0,i=(t=t.trim()).split(/</),o=0,l=i.length;o<l;o++){var r=i[o].split(/>/);2===r.length?("/"===i[o][0]&&n--,a+=e(n),"/"!==i[o][0]&&n++,o>0&&(a+="<"),a+=r[0].trim()+">\n",""!==r[1].trim()&&(a+=e(n)+r[1].trim().replace(/\s+/g," ")+"\n"),r[0].match(/^(img|hr|br)/)&&n--):a+=e(n)+r[0]+"\n"}return a},this.editImage=function(e){var a=e.target,n=a.title,i=a.width,o=a.height;mdl.open({id:"fEditor",width:700,title:"Edit Image",cb:function(){t("#page").radio()},content:t("<div/>",{class:"imgEdit",html:t("<div/>",{class:"iZone",html:t("<img/>",{src:e.target.src})})}).append(t("<div/>",{class:"eZone",html:t("<div/>",{class:"iGroup ie",html:t("<label/>",{html:"Title"})}).append(t("<input/>",{type:"text",name:"title",value:n}))}).append(t("<div/>",{class:"iGroup ie",html:t("<label/>",{html:"Link"})}).append(t("<input/>",{type:"text",name:"link",value:""}))).append(t("<div/>",{class:"iGroup ie",html:t("<label/>",{html:"Size"})}).append(t("<div/>",{class:"rGroup",html:t("<input/>",{type:"number",name:"width",class:"iSize",value:i})}).append(t("<span/>",{class:"fa fa-times sz"})).append(t("<input/>",{type:"number",name:"height",class:"iSize",value:o})).append("px"))).append(t("<div/>",{class:"iGroup ie",html:t("<label/>",{html:"Align"})}).append(t("<div>",{class:"iALign",html:t("<input/>",{type:"radio",name:"iAlign","data-label":"left",value:"left"})}).append(t("<input/>",{type:"radio",name:"iAlign","data-label":"center",value:"center"})).append(t("<input/>",{type:"radio",name:"iAlign","data-label":"right",value:"right"}))))).append(t("<div/>",{class:"ieBottom",html:t("<button/>",{class:"btn btnSave",html:"Save",onclick:"save()"})}))})},this.editLink=function(e,a){var n=this;if(a)var i=n.getSelection(),o=n.getRange(n.area,e),l="";else var r=t(e.target),i=r.html(),l=r.attr("href");mdl.open({id:"feEditor",title:"Adding link",content:'<div class="iGroup">\t\t\t\t\t<label>Text:</label>\t\t\t\t\t<input type="text" name="text" value="'+i+'">\t\t\t\t</div>\t\t\t\t<div class="iGroup">\t\t\t\t\t<label>Link:</label>\t\t\t\t\t<input type="text" name="link" value="'+l+'">\t\t\t\t</div>\t\t\t\t<div class="sGroup">\t\t\t\t\t<button class="btn btnSubmit">Insert</button>\t\t\t\t</div>'}),t("#feEditor button").click(function(){var l=t('#feEditor input[name="text"]').val(),s=t('#feEditor input[name="link"]').val();a?(i.removeAllRanges(),o&&i.addRange(o),n.command(n.area,"insertHTML",!1,'<a href="'+s+'" target="blank_">'+l+"</a>",e)):r.html(l).attr("href",s),mdl.close()})},this.getSelection=function(){return e.getSelection?e.getSelection():""},this.command=function(t,e,n,i,o){o.preventDefault();var l=this.getSelection(t),r=!1;if(l&&l.rangeCount){var s=l.getRangeAt(0);r=s.commonAncestorContainer||(s.parentElement?s.parentElement():s.item(0))}for(;r&&r!=t[0];)r=r.parentNode;r||this.setFocus(t[0],!1,!0),a.execCommand(e,n,i)},this.getRange=function(t,e){e.preventDefault();var a=this.getSelection(t);return a.rangeCount?a.getRangeAt(0):null},this.setFocus=function(t){if(void 0!==e.getSelection&&void 0!==a.createRange){var n=e.getSelection();(i=a.createRange()).selectNodeContents(t),i.collapse(!1),(n=e.getSelection()).removeAllRanges(),n.addRange(i)}else if(void 0!==a.body.createTextRange){var i=a.body.createTextRange();i.moveToElementText(t),i.collapse(!1),i.select()}},this.createButton=function(e,a){function n(e,a){t.each(a,function(a,n){t.each(n,function(a,n){i=t("<button/>",{class:"eBtn "+a,type:"button"});if("function"==typeof n)i.mousedown(n);else var i=t("<div/>",{class:"eBox",html:i}).append(t("<div/>",{class:"eDrop"+(n[2]?" "+n[2]:""),html:n[0]}).mousedown(n[1]));t(e).append(i)})})}if(a.length){var i=t("<div/>",{class:"eGrp"}).appendTo(e);t.each(a,function(){n(i,this)})}else n(e,a)},this.methods={resize:function(e,a){this.lang.resize;this.createButton(e,{lng:{"fa fa-expand rsz":function(a){t(e).parent().hasClass("fullScreen")?(t("body").css("overflow","auto"),t(e).find(".rsz").addClass("fa-expand").removeClass("fa-compress").parents(".editor").removeClass("fullScreen")):(t(e).find(".rsz").removeClass("fa-expand").addClass("fa-compress").parents(".editor").addClass("fullScreen"),t("body").css("overflow","hidden"))}}})},style:function(t,e){var a=this,n=a.lang;n.bold,n.italic,n.strike,n.underline;this.createButton(t,[{bold:{"fa fa-bold":function(t){a.command(e,"bold",!1,null,t)}}},{italic:{"fa fa-italic":function(t){a.command(e,"italic",!1,null,t)}}},{strike:{"fa fa-strikethrough":function(t){a.command(e,"strikeThrough",!1,null,t)}}},{underline:{"fa fa-underline":function(t){a.command(e,"underline",!1,null,t)}}}])},aligment:function(t,e){var a=this,n=a.lang;n.left,n.center,n.right;this.createButton(t,[{left:{"fa fa-align-left":function(t){a.command(e,"justifyLeft",!1,null,t)}}},{center:{"fa fa-align-center":function(t){a.command(e,"justifyCenter",!1,null,t)}}},{right:{"fa fa-align-right":function(t){a.command(e,"justifyRight",!1,null,t)}}},{full:{"fa fa-align-justify":function(t){a.command(e,"justifyFull",!1,null,t)}}}])},indent:function(t,e){var a=this,n=a.lang;n.indent,n.outdent;this.createButton(t,[{indent:{"fa fa-indent":function(t){a.command(e,"indent",!1,null,t)}}},{outdent:{"fa fa-outdent":function(t){a.command(e,"outdent",!1,null,t)}}}])},list:function(t,e){var a=this,n=a.lang;n.list,n.numlist;this.createButton(t,[{list:{"fa fa-list-ul":function(t){a.command(e,"insertUnorderedList",!1,null,t)}}},{numlist:{"fa fa-list-ol":function(t){a.command(e,"insertOrderedList",!1,null,t)}}}])},insert:function(e,a){for(var n=this,i=n.lang,o=(i.quote,i.hr,""),l=10,r=0,s=1;s<=100;s++){r<10?r++:r=1;var d=10*r;o+='<span data-row="'+s+'" style="width:'+l+"%;height:"+d+"%;z-index:"+(100-s)+'" title="'+d/10+","+l/10+'"></span>',100==d&&(l+=10)}this.createButton(e,[{quote:{"fa fa-quote-left":function(t){var e=n.getSelection(a);e&&n.command(a,"insertHTML",!1,"<blockquote>"+e+"</blockquote>&nbsp;",t)}}},{hr:{"fa fa-minus":function(t){n.command(a,"InsertHorizontalRule",!0,"",t)}}},{link:{"fa fa-link":function(t){n.editLink(t,!0)}}},{table:{"fa fa-table":[o,function(t){var e=t.target.getAttribute("title"),i="",o=n.getSelection(),l=n.getRange(a,t);if(e){for(var r=e.split(","),s=0;s<r[0];s++){i+="<tr>";for(var d=0;d<r[1];d++)i+="<td>&#65279;</td>";i+="</tr>"}o.removeAllRanges(),l&&o.addRange(l),n.command(a,"insertHTML",!1,'<table cellspacing="5" cellpadding="0">'+i+"</table>&nbsp;",t)}},"table"]}},{image:{"fa fa-photo":function(e){var i=n.getSelection(),o=n.getRange(a,e),l=(location.pathname.split("/"),'<div class="loader">\t\t\t\t\t\t\t\t\t<i class="fa fa-cog fa-spin fa-3x fa-fw"></i>\t\t\t\t\t\t\t\t\t<span class="">Image is loading. Please, wait...</span>\t\t\t\t\t\t\t\t</div>');mdl.open({id:"fEditor",title:"Insert Image",content:t("<div/>",{class:"dragndrop",html:t("<span/>",{class:"fa fa-download"})}).append("Click or drag and drop file here").upload({check:function(r){if(r.error)"type"==e.error?alr.show({class:"alrDanger",content:"You can load only jpeg, jpg, png, gif images",delay:2}):"size"==e.error&&alr.show({class:"alrDanger",content:"Upload size for images is more than allowable",delay:2});else{t("#fEditor .mdlBody").html(l);var s=new FormData;s.append("image",r.file,r.file.name),t.ajax({type:"POST",processData:!1,contentType:!1,url:"/editor",data:s}).done(function(t){var l=JSON.parse(t);l.error||(i.removeAllRanges(),o&&i.addRange(o),n.command(a,"insertHTML",!1,'<img src="'+l.image+'">&nbsp;',e),mdl.close())})}}})}),t("#fEditor .mdlBody").append(l),t.getJSON("/editor/list",function(e){e.length?(t("#fEditor .loader").replaceWith(t("<div/>",{class:"thumbnails"})),t.each(e,function(){t("#fEditor .thumbnails").append(t("<div/>",{class:"thumb",html:t("<img/>",{src:this}).click(function(t){i.removeAllRanges(),o&&i.addRange(o),n.command(a,"insertHTML",!1,'<img src="'+t.target.src.replace(location.origin,"").replace("thumb_","")+'">&nbsp;',t),mdl.close()})}).append(t("<span/>",{class:"fa fa-times"}).click(function(e){var a=t(e.target.parentNode),n=a.find("img[src]").attr("src");a.remove(),t.post("/editor/del_image",{image:n})})))})):t("#fEditor .loader").remove()})}}},{youtube:{"fa fa-youtube":function(e){var i=n.getSelection(),o=n.getRange(a,e);mdl.open({id:"feEditor",title:"Youtube link",content:'<div class="iGroup">\t\t\t\t\t\t\t\t\t<label>URL:</label>\t\t\t\t\t\t\t\t\t<input type="text" name="url">\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div class="sGroup">\t\t\t\t\t\t\t\t\t<button class="btn btnSubmit">Insert</button>\t\t\t\t\t\t\t\t</div>'}),t("#feEditor button").click(function(){var l=t('#feEditor input[name="url"]').val().match(/^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/);l&&11===l[1].length?(i.removeAllRanges(),o&&i.addRange(o),n.command(a,"insertHTML",!1,'<iframe src="//www.youtube.com/embed/'+l[1]+'" frameborder="0" width="640" height="360"></iframe>&nbsp;',e),mdl.close()):alert("Ссылка не верная")})}}}])},code:function(e,a){var n=this,i=n.lang;i.format,i.code;this.createButton(e,[{format:{"fa fa-eraser":function(t){n.getSelection(a)&&n.command(a,"removeFormat",!1,null,t)}}},{code:{"fa fa-code":function(i){if(a.code)a.show().next().hide(),a.code=!1,t(e).parent().find(".eTools button:not(.fa-code, .rsz)").removeAttr("disabled");else{var o=a.hide().next().show();o.val(n.form_html(o.val()).trim()),a.code=!0,t(e).parent().find(".eTools button:not(.fa-code, .rsz)").attr("disabled","disabled")}}}}])},font:function(e,a){var n=this,i=n.lang,o=(i.color,i.background,i.family,i.size,i.header),l=["#fff","#000","#eee","#f00","#00f","#F2FB5B","#EB981B","#EB567F","#C625DA","#6DBDF5","#5BD4B8","#44C06A","#6FE760","#C2C2C2","#464646"],r=["cursive","fantasy","monospace","sans-serif","serif"],r=["cursive","fantasy","monospace","sans-serif","serif"],s="",d="<ul>",c="<ul>",f="<ul>";t.each(l,function(){s+='<span data-color="'+this+'" style="background: '+this+'"></span>'}),t.each(r,function(){d+='<li data-family="'+this+'" class="'+this+'">'+this+"</li>"});for(u=1;u<=7;u++)c+='<li data-size="'+u+'"><font size="'+u+'" data-size="'+u+'">'+i.text+"</font></li>";for(var u=1;u<=6;u++)f+='<li data-header="'+u+'" class="h'+u+'">'+o+" "+u+"</li>";this.createButton(e,[{color:{"fa fa-adjust":[s,function(t){var e=t.target.getAttribute("data-color");e&&n.command(a,"foreColor",!0,e,t)},"color"]}},{background:{"fa fa-th":[s,function(t){var e=t.target.getAttribute("data-color");e&&n.command(a,"backColor",!0,e,t)},"color"]}},{family:{"fa fa-font":[d+"</ul>",function(t){var e=t.target.getAttribute("data-family");e&&n.command(a,"fontName",!0,e,t)},"family"]}},{size:{"fa fa-text-height":[c+"</ul>",function(t){var e=t.target.getAttribute("data-size");e&&n.command(a,"fontSize",!0,e,t)},"size"]}},{header:{"fa fa-header":[f+"</ul>",function(t){var e=t.target.getAttribute("data-header");e&&n.command(a,"formatBlock",!0,"H"+e,t)},"header"]}}])},history:function(t,e){var a=this,n=a.lang;n.undo,n.redo;this.createButton(t,[{undo:{"fa fa-undo":function(t){a.command(e,"undo",!1,null,t)}}},{redo:{"fa fa-repeat":function(t){a.command(e,"redo",!1,null,t)}}}])}}}(window,document)}(jQuery);