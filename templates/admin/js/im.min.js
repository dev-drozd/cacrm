var Im={page:1,f:!1,upage:1,uf:!1,sp:!1,getYoutube:function(e,a){function i(){location.pathname.match(/im/i)?m.height(m.width()*l):$(window).unbind("resize",i)}var t=$(e),s=t.width(),n=t.height(),l=t.height()/t.width(),m=$("<iframe/>",{width:s,height:n,frameborder:0,allowfullscreen:!0,src:"//www.youtube.com/embed/"+a+(a.indexOf("?")>0?"&":"?")+"autoplay=true"});t.replaceWith(m),$(window).resize(i),i()},history:function(){Im.f||(Im.f=!0,support=-1!=location.pathname.indexOf("support")?"support/":-1!=location.pathname.indexOf("emails")?"emails/":"",$.post("/im/"+support+"history",{page:Im.page,id:$(".imDialog").attr("data-id")},function(e){if(e.res_count){var a=document.querySelector(".imDialog").scrollHeight;Im.page++,Im.f=!1,$(".imDialog").prepend(e.content),$(".imDialog").scrollTop(document.querySelector(".imDialog").scrollHeight-a)}},"json"))},tab:function(e,a){var i=$(e).parent();return a?(Im.sp=!0,$(".imUser.gc").hide()):(Im.sp=!1,$(".imUser.gc").show()),2==a?($(".btnIm + ul").hide(),$(".newEmail").show()):($(".btnIm + ul").show(),$(".newEmail").hide()),history.pushState({link:"/im"+(a?1==a?"/support":"/emails":"")},null,"/im"+(a?1==a?"/support":"/emails":"")),a?(Im.f=!0,$(".imDialog").html('<div class="imNoCont">No chats</div>')):Im.open($(".imUser.gc")[0]),$.post("/im/tab",{support:a},function(e){a&&(Im.f=!1),$(".imDialogs").html(e.im.content)},"json"),a?1==a?i.removeClass("email").addClass("support"):i.removeClass("support").addClass("email"):i.removeClass("support").removeClass("email")},setFocus:function(){var e=$("textarea"),a=e.val();e.val("").focus().val(a)},tooltip:function(e,a,i){var t=$(e),s=t.find("div");"undefined"==typeof e.myData&&(e.myData="",s.html('<i class="fa fa-spinner fa-pulse fa-fw"></i>'),$.getJSON("/tags/"+a.toLowerCase()+"/"+i,function(a){var i="";"OK"==a.status&&(a.images&&(a.photo="/uploads/images/inventory/"+a.id+"/"+a.images.split("|")[0]),a.photo&&(i+='<img src="'+a.photo+'">'),a.event&&(i+="<h4>Event: "+a.event+"</h4>"),a.title&&(i+="<h4>"+a.title+"</h4>"),a.descr&&(i+="<p>"+a.descr+"</p>"),a.price&&(i+='<p class="ttPrice">Price: $'+a.price.replace("$","")+"</p>"),a.date&&(i+='<p class="ttPrice">Date: '+a.date+"</p>"),s.html(i)),e.myData=i}))},tagLink:function(e,a){var i=location.origin;switch(e.toLowerCase()){case"purchase":case"rma":i+="/purchases/edit/"+a;break;case"issue":i+="/issues/view/"+a;break;case"stock":i+="/inventory/view/"+a;break;case"user":i+="/users/view/"+a;break;case"camera":return!1}return window.open(i),!1},undo:function(e){e&&$.post("/im/undo",{id:e,sid:$(".imDialog").attr("data-id")},function(a){var i=$('.imMes[data-msg="'+e+'"] .imMesText'),t=i.find(".imDate").text();i.html('<span class="fa fa-times imDel" onclick="Im.del('+e+')"></span><span class="imDate">'+t+"</span>"+a.msg)},"json")},paste:function(e){for(var a=(e.clipboardData||e.originalEvent.clipboardData).items,i={files:[]},t=$(".imageUpload")[0],s=0;s<a.length;s++)if(0===a[s].type.indexOf("image")){e.preventDefault();var n=a[s].getAsFile();n.name="file "+(s+1),i.files.push(n)}t.check(i),console.log(e)},init:function(){var e=location.pathname.match(/\/im\/([0-9]+)/i);e&&$('.imLeft .imUser[data-id="'+e[1]+'"]').addClass("active").find(".imCount").remove()},search:function(e){$.post(location.href,{query:e.value},function(e){Im.upage=1,Im.uf=!1,$(".imDialogs").html(e.content)},"json")},open:function(e){Im.page=1,Im.f=!0;var a=$(e),i=a.attr("data-id"),t=Number(a.find(".imCount").text()),s=$("#new_msg > a > .newMsg"),n=-1!=location.pathname.indexOf("support")?"support/":-1!=location.pathname.indexOf("emails")?"emails/":"";if("all"==i&&-1!==$.inArray("1",_user.groups.split(","))?$(".sendAll").show():$(".sendAll").hide(),t>0&&s){var l=Number(s.text())-t;l>0?s.text(l):s.remove()}$(".imDialog").html($("<div/>",{"class":"imAnim",html:$("<span/>",{"class":"fa fa-pulse fa-spinner"})})),$(".newEmail-info").remove(),$(".imLeft .imUser.active").removeClass("active"),a.addClass("active").find(".imCount").remove(),history.pushState({link:"/im/"+n+i},null,"/im/"+n+i),$(".imDialog").attr("data-id",i),$(".imLeft").removeClass("open"),$.post("/im/"+n+"history",{id:i},function(e){Im.f=!1,$(".imDialog").html(e.content).scrollTop(999999999),Im.setFocus()},"json")},send_flag:!1,send:function(e){if((this.send_flag||!$("#message").val().trim())&&!$(".filesUpload").length&&!$(".imageUpload").length)return!1;if(this.send_flag=!0,$(".newEmail-info").length&&(!$('input[name="nmEmail"]').val()||!$('input[name="nmSubject"]').val()))return alr.show({"class":"alrDanger",content:"Enter email and subject",delay:2}),!1;$(".imNoCont").length&&$(".imNoCont").remove(),$(".imMessage button").attr("disabled","disabled").prepend($("<span/>",{"class":"fa fa-spin fa-circle-o-notch"}));var a=location.pathname.match(/\/im\/(?:(support|emails)\/)?(.+)/i),i=$("#message").val().trim(),t=new FormData,s=-1!=location.pathname.indexOf("support")?"support/":-1!=location.pathname.indexOf("emails")?"emails/":"",n=a&&"emails"==a[1]?!0:!1;if(t.append("id",$(".newEmail-info").length?$('input[name="nmEmail"]').val()+":|:"+$('input[name="nmSubject"]').val():a?a[2]:0),t.append("message",i),t.append("all",$("#sendAll").val()),$(".newEmail-info").length&&t.append("new",1),$('select[name="nmFrom"]').length&&t.append("from",$('select[name="nmFrom"]').val()),"1"===$("#sendAll").val()&&$("#sendAll").val(0).click(),$(".filesUpload").length){var l=$(".filesUpload")[0].files;if(!$.isEmptyObject(l))for(var m in l)t.append("files[]",l[m])}if($(".imageUpload").length){var l=$(".imageUpload")[0].files;if(!$.isEmptyObject(l))for(var m in l)t.append("images[]",l[m])}if(i.length||l||images){if(n){var o=new Date;$(".imDialog").append(Im.compile({type:"messages",id:"",uid:"",sid:"",image:"",name:"admin@yoursite.com",lastname:"",message:i,my:!0,date:o.getFullYear()+"-"+(o.getMonth()+1<10?"0"+(o.getMonth()+1):o.getMonth()+1)+"-"+o.getDate()})).scrollTop(999999999),$("#message").val("")}s&&$(".block").remove(),$.ajax({type:"POST",dataType:"json",processData:!1,contentType:!1,url:"/im/"+s+"send",data:t}).done(function(e){if(Im.send_flag=!1,$(".imMessage button").attr("disabled",!1).find("span").remove(),"err_file_type"==e)alr.show({"class":"alrDanger",content:"Uploading files types are prohibited",delay:2});else if("err_image_type"==e)alr.show({"class":"alrDanger",content:"Uploading images types are prohibited",delay:2});else if("no_acc"==e.err)alr.show({"class":"alrDanger",content:"You have no access to do this",delay:2}),$(".imDialog > .imMes").last().remove();else if($(".newEmail-info").length)Page.get("/im/emails/"+($('input[name="nmEmail"]').val()+":|:"+$('input[name="nmSubject"]').val()).replace(".","::"));else{var i=$("#"+(s?"chat_guest":"chat_user")+(a?a[1]:0)+" .mini-chat-messages");i.length&&i.append(Chat.compileMsg([e.message])).scrollTop(999999999),n||($(".imDialog").append(Im.compile(e.message)).scrollTop(999999999),$("#message").val("")),$(".imMessage .thumbnails").html(""),$(".imMessage .files").html(""),$(".filesUpload")[0].input.value="",$(".filesUpload")[0].files={},$(".filesUpload")[0].count=0,$(".imageUpload")[0].input.value="",$(".imageUpload")[0].files={},$(".imageUpload")[0].count=0,$(".imDialog").css("height",$(".im").height()-$(".imMessage").height()-35)}})}else alr.show({"class":"alrDanger",content:"Message can not be empty",delay:2})},viewed:function(e){$.post("/im/viewed",{sid:e})},compile:function(e){console.log(e);var a=$("[data-usr]").last().attr("data-usr"),i=e.uid!=a;return'<div class="imMes'+(e.my?" my":"")+(i?" first":"")+'" data-msg="'+e.id+'" data-usr="'+e.uid+'">				'+(i?'<a href="href=/users/view/'+e.uid+'" target="_blank">				'+(e.image?'<img src="/uploads/images/users/'+e.uid+"/thumb_"+e.image+'" class="imImg">':'<span class="fa fa-user imImg"></span>')+"			</a>":"")+'			<div>				<div class="imMesTop">					'+(i?'<a href="#">'+e.name+" "+e.lastname+"</a>":"")+'				</div>				<div class="imMesText'+(e.my&&/\/im\/(?:support\/)?([0-9]+)/.test(location.pathname)?" new":"")+'">					'+(e.my?'<span class="fa fa-times imDel" onclick="Im.del('+e.id+')"></span>':"")+'<span class="imDate">'+e.date+"</span>					"+e.message+"				</div>			</div>		</div>"},del:function(e){support=-1!=location.pathname.indexOf("support")?"support/":-1!=location.pathname.indexOf("emails")?"emails/":"",e&&$.post("/im/"+support+"del",{id:e,sid:$(".imDialog").attr("data-id")},function(a){if("OK"==a)if("emails/"==support)$('.imMes[data-msg="'+e+'"]').remove();else{var i=$('.imMes[data-msg="'+e+'"] .imMesText > .imDate').text();$('.imMes[data-msg="'+e+'"] .imMesText').html($("<span/>",{"class":"fa fa-undo imDel",onclick:"Im.undo("+e+");"})).append($("<span/>",{"class":"imDate",text:i})).append($("<span/>",{"class":"fa fa-trash imDeleted"})).append("Message deleted")}else"ERR"==a&&alr.show({"class":"alrDanger",content:"You are not allowed to do this",delay:2})})},delTree:function(e){var a=$(e).parent().attr("data-id");a&&$.post("/im/delTree",{id:a},function(a){"OK"==a?($(e).parent().remove(),$(".imDialog").empty()):"ERR"==a&&alr.show({"class":"alrDanger",content:"You are not allowed to do this",delay:2})})},newEmail:function(){$(".newEmail-info").length||$.post("/im/config_emails",{},function(e){e?($(".imChats").prepend($("<div/>",{"class":"newEmail-info",html:$("<div/>",{"class":"nmEmail",html:$("<label/>",{html:"Email:"})}).append($("<input/>",{type:"email",name:"nmEmail"}))}).append($("<div/>",{"class":"nmSubject",html:$("<label/>",{html:"Subject:"})}).append($("<input/>",{type:"text",name:"nmSubject"}))).append($("<div/>",{"class":"nmFrom",html:$("<label/>",{html:"From:"})}).append($("<select/>",{name:"nmFrom",html:e})))),$("select").select(),$(".imUser.active").removeClass("active"),$(".imDialog").removeAttr("data-id").html("")):alr.show({"class":"alrDanger",content:"You have no default email",delay:2})})}};